<!doctype html>
<html lang="fr">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sélecteur de scénarios</title>
<link rel="stylesheet" href="/style.css" />
<script src="/js/config.js"></script>
<script src="/js/utils.js"></script>
<body>
<header class="bar"><h1>Simulateur SAV — Scénarios</h1><div class="small" id="uinfo"></div></header>
<main style="padding:16px">
  <div class="card">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button class="btn" id="reload">Recharger</button>
      <button class="btn" id="logout" style="background:#ef4444;color:#fff">Déconnexion</button>
      <span class="small">Token stocké en local (navigateur).</span>
    </div>
  </div>
  <div id="list" class="grid"></div>
  <pre id="out" class="small"></pre>
</main>
<script>
const out = document.getElementById('out');
const list = document.getElementById('list');
const userInfo = document.getElementById('uinfo');
const reloadBtn = document.getElementById('reload');
const logoutBtn = document.getElementById('logout');

function redirectToLogin(message) {
  if (message) {
    out.textContent = message;
  }
  SAV.clearToken();
  location.href = '/';
}

async function whoAmI() {
  const token = SAV.getToken();
  if (!token) {
    return '(non connecté)';
  }
  try {
    const { data } = await SAV.supabaseFetch('auth/v1/user');
    if (!data) {
      return '(inconnu)';
    }
    return data.email || data.id || '(inconnu)';
  } catch (e) {
    if (e.status === 401 || e.status === 403) {
      redirectToLogin('Token expiré, veuillez vous reconnecter.');
    }
    return '(token invalide)';
  }
}

async function loadScenarios() {
  const token = SAV.getToken();
  if (!token) {
    redirectToLogin('⚠️ Pas de token: retour à la page de connexion.');
    return;
  }

  list.innerHTML = '';
  out.textContent = 'Chargement...';

  try {
    const { data } = await SAV.supabaseFetch('rest/v1/scenarios', {
      searchParams: {
        select: 'id,title,level,persona,mode',
        order: 'level.asc'
      }
    });

    if (!Array.isArray(data) || data.length === 0) {
      out.textContent = 'Aucun scénario visible.';
      return;
    }

    out.textContent = '';
    data.forEach(sc => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <h3 style="margin:0 0 6px 0">${sc.title}</h3>
        <div class="small">Niveau: ${sc.level} · Persona: ${sc.persona} · Mode: ${sc.mode}</div>
        <div style="margin-top:10px">
          <button class="btn" data-id="${sc.id}">Lancer</button>
        </div>`;
      list.appendChild(card);
    });

    list.querySelectorAll('button').forEach(btn => {
      btn.onclick = async () => {
        const scenarioId = Number(btn.dataset.id);
        if (!scenarioId) {
          return;
        }
        out.textContent = 'Création de la session...';
        const result = await SAV.fetchJSON('/api/new-session', {
          method: 'POST',
          body: { scenario_id: scenarioId },
          throwOnError: false
        });
        if (!result.ok) {
          const errData = result.data;
          const message = typeof errData === 'string' ? errData : JSON.stringify(errData);
          out.textContent = 'Erreur: ' + message;
          if (result.status === 401 || result.status === 403) {
            redirectToLogin('Session expirée, veuillez vous reconnecter.');
          }
          return;
        }
        const payload = result.data || {};
        if (!payload.session_id) {
          out.textContent = 'Réponse inattendue du serveur.';
          return;
        }
        location.href = `/chat.html?session_id=${encodeURIComponent(payload.session_id)}`;
      };
    });
  } catch (e) {
    if (e.status === 401 || e.status === 403) {
      redirectToLogin('Token expiré, veuillez vous reconnecter.');
      return;
    }
    const errMsg = typeof e?.data === 'string' ? e.data : (e?.message || e);
    out.textContent = 'Erreur chargement: ' + errMsg;
  }
}

logoutBtn.addEventListener('click', () => {
  SAV.clearToken();
  location.href = '/';
});

reloadBtn.addEventListener('click', () => loadScenarios());

whoAmI().then(email => {
  userInfo.textContent = email;
});

loadScenarios();
</script>
</body>
</html>
