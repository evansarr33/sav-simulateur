<!doctype html>
<html lang="fr">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sélecteur de scénarios</title>
<style>
body{font-family:system-ui;margin:0;background:#0f172a;color:#e5e7eb}
header,footer{padding:12px 16px;background:#111827;border-bottom:1px solid #222}
main{padding:16px}
input,textarea{background:#0b1220;color:#e5e7eb;border:1px solid #223;border-radius:8px;padding:8px}
.card{background:#1f2937;border:1px solid #273244;border-radius:12px;padding:12px;margin:10px 0}
.btn{background:#60a5fa;color:#0b1220;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:600}
.grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
.small{color:#9ca3af;font-size:12px}
</style>
<body>
<header>
  <h2 style="margin:0">Sélecteur de scénarios</h2>
</header>

<main>
  <p>Colle ton <b>token</b> d’agent (depuis <code>/token.html</code>) puis choisis un scénario.</p>
  <div style="margin:8px 0">
    <input id="tok" placeholder="Authorization: Bearer &lt;token&gt;" style="width:100%">
  </div>

  <div id="list" class="grid"></div>
  <pre id="out" class="small"></pre>
</main>

<script>
const SUPABASE_URL  = "https://bkgpmfqzkzxehjgshnga.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrZ3BtZnF6a3p4ZWhqZ3NobmdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDM2NDAsImV4cCI6MjA3NTQ3OTY0MH0.1BHkv-grxjDz92bovjDjb-8dHaWPSvQruudVx1kkdqw";

const out = document.getElementById('out');
const list = document.getElementById('list');
const tok  = () => document.getElementById('tok').value.trim();

async function loadScenarios(){
  out.textContent = "Chargement...";
  const r = await fetch(`${SUPABASE_URL}/rest/v1/scenarios?select=id,title,level,persona,mode&order=level.asc`, {
    headers: { apikey: SUPABASE_ANON, Authorization: `Bearer ${SUPABASE_ANON}` }
  });
  const rows = await r.json();
  list.innerHTML = "";
  rows.forEach(sc => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h3 style="margin:0 0 6px 0">${sc.title}</h3>
      <div class="small">Niveau: ${sc.level} · Persona: ${sc.persona} · Mode: ${sc.mode}</div>
      <div style="margin-top:10px">
        <button class="btn" data-id="${sc.id}">Lancer</button>
      </div>
    `;
    list.appendChild(card);
  });

  list.querySelectorAll('button').forEach(btn=>{
    btn.onclick = async () => {
      const token = tok();
      if (!token) { out.textContent = "⚠️ Colle d'abord ton token (Authorization)."; return; }
      const scenario_id = Number(btn.dataset.id);
      out.textContent = "Création de la session...";
      const resp = await fetch("/api/new-session", {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Authorization":"Bearer " + token },
        body: JSON.stringify({ scenario_id })
      });
      const data = await resp.json();
      if (!resp.ok) { out.textContent = "Erreur: " + JSON.stringify(data); return; }
      // redirige vers le chat
      location.href = `/chat.html?session_id=${encodeURIComponent(data.session_id)}`;
    };
  });

  out.textContent = "Prêt.";
}

loadScenarios();
</script>
</body>
</html>
