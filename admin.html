<!doctype html>
<html lang="fr">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin / Formateur — Simulateur SAV</title>
<link rel="stylesheet" href="/style.css" />
<body>
<header class="bar"><h1>Dashboard formateur</h1><div><button class="btn" id="reload">Recharger</button></div></header>
<main style="padding:16px">
  <div class="card">
    <div class="small">Accès réservé aux <b>formateurs</b>. Si vous voyez une erreur 403, demandez à l'admin de vous donner le rôle trainer.</div>
  </div>
  <div id="kpis" class="grid"></div>
  <div class="card">
    <h3>Sessions récentes</h3>
    <div id="sessions"></div>
  </div>
  <pre id="log" class="small"></pre>
</main>
<script>
const token = localStorage.getItem("sav_token") || "";
const log = document.getElementById('log');
document.getElementById('reload').onclick = () => loadAll();

function el(tag, html, cls) {
  const d = document.createElement(tag);
  if (cls) d.className = cls;
  d.innerHTML = html;
  return d;
}

async function loadAll() {
  try {
    log.textContent = "Chargement...";
    if (!token) { location.href = "/"; return; }
    const r = await fetch("/api/admin-stats", { headers: { Authorization: "Bearer " + token } });
    const data = await r.json();
    if (!r.ok) { log.textContent = "Erreur: " + JSON.stringify(data); return; }

    const { kpis, sessions } = data;
    const k = document.getElementById('kpis');
    k.innerHTML = "";
    k.appendChild(el('div', `<div class="card"><div class="small">Score moyen</div><div style="font-size:28px;font-weight:800">${kpis.avgScore}</div></div>`));
    k.appendChild(el('div', `<div class="card"><div class="small">Coût cumulé gestes (€)</div><div style="font-size:28px;font-weight:800">${kpis.costEUR.toFixed ? kpis.costEUR.toFixed(2) : kpis.costEUR}</div></div>`));
    k.appendChild(el('div', `<div class="card"><div class="small">Sessions clôturées</div><div style="font-size:28px;font-weight:800">${kpis.resolved} / ${kpis.total} ( ${kpis.rate}% )</div></div>`));

    const cont = document.getElementById('sessions');
    cont.innerHTML = "";
    sessions.forEach(s => {
      cont.appendChild(el('div', `
        <div class="card">
          <div><b>Session</b>: ${s.id} — <b>État</b>: ${s.state}</div>
          <div class="small">Début: ${s.started_at || "—"} — Fin: ${s.ended_at || "—"}</div>
        </div>`));
    });

    log.textContent = "OK";
  } catch (e) {
    log.textContent = "Erreur: " + e.message;
  }
}
loadAll();
</script>
</body>
</html>
