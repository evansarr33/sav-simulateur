<!doctype html>
<html lang="fr">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin / Formateur — Simulateur SAV</title>
<link rel="stylesheet" href="/style.css" />
<script src="/js/config.js"></script>
<script src="/js/utils.js"></script>
<body>
<header class="bar"><h1>Dashboard formateur</h1><div><button class="btn" id="reload">Recharger</button></div></header>
<main style="padding:16px">
  <div class="card">
    <div class="small">Ce tableau lit les données via Supabase REST avec votre token. Assurez-vous d'avoir le rôle <b>trainer</b> pour voir toutes les sessions.</div>
  </div>
  <div id="kpis" class="grid"></div>
  <div class="card">
    <h3>Sessions récentes</h3>
    <div id="sessions"></div>
  </div>
  <pre id="log" class="small"></pre>
</main>
<script>
const log = document.getElementById('log');
const reloadBtn = document.getElementById('reload');

function redirectToLogin(reason) {
  log.textContent = reason || 'Token manquant.';
  SAV.clearToken();
  setTimeout(() => {
    location.href = '/';
  }, 800);
}

async function q(path) {
  const result = await SAV.supabaseFetch(`rest/v1/${path}`);
  return result.data;
}

function el(tag, html, cls) {
  const d = document.createElement(tag);
  if (cls) d.className = cls;
  d.innerHTML = html;
  return d;
}

async function loadAll() {
  const token = SAV.getToken();
  if (!token) {
    redirectToLogin('Token introuvable, merci de vous reconnecter.');
    return;
  }

  try {
    log.textContent = 'Chargement...';
    const sessions = await q('sessions?select=id,user_id,scenario_id,state,started_at,ended_at&order=started_at.desc&limit=50');
    const scores = await q('scores?select=session_id,total&limit=1000');
    const actions = await q('actions?select=session_id,approved,amount_cents,type&limit=1000');

    const scoreVals = (scores || []).map(s => s.total).filter(n => typeof n === 'number');
    const avgScore = scoreVals.length ? Math.round(scoreVals.reduce((a, b) => a + b, 0) / scoreVals.length) : 0;
    const cost = (actions || []).reduce((sum, a) => sum + (a.amount_cents || 0), 0);
    const resolved = (sessions || []).filter(s => s.state === 'closed').length;
    const total = sessions?.length || 0;
    const rate = total ? Math.round((resolved / total) * 100) : 0;

    const kpis = document.getElementById('kpis');
    kpis.innerHTML = '';
    kpis.appendChild(el('div', `<div class="card"><div class="small">Score moyen</div><div style="font-size:28px;font-weight:800">${avgScore}</div></div>`));
    kpis.appendChild(el('div', `<div class="card"><div class="small">Coût cumulé gestes (€)</div><div style="font-size:28px;font-weight:800">${(cost / 100).toFixed(2)}</div></div>`));
    kpis.appendChild(el('div', `<div class="card"><div class="small">Sessions clôturées</div><div style="font-size:28px;font-weight:800">${resolved} / ${total} ( ${rate}% )</div></div>`));

    const cont = document.getElementById('sessions');
    cont.innerHTML = '';
    (sessions || []).forEach(s => {
      const row = el('div', `
        <div class="card">
          <div><b>Session</b>: ${s.id} — <b>État</b>: ${s.state}</div>
          <div class="small">Début: ${s.started_at || '—'} — Fin: ${s.ended_at || '—'}</div>
        </div>`);
      cont.appendChild(row);
    });

    log.textContent = 'OK';
  } catch (e) {
    if (e.status === 401 || e.status === 403) {
      redirectToLogin('Accès refusé. Merci de vous reconnecter.');
      return;
    }
    log.textContent = 'Erreur: ' + (e?.message || e);
  }
}

reloadBtn.addEventListener('click', () => loadAll());

if (!SAV.getToken()) {
  redirectToLogin('Token introuvable, merci de vous reconnecter.');
} else {
  loadAll();
}
</script>
</body>
</html>
