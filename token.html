<!doctype html>
<html lang="fr">
<meta charset="utf-8" />
<title>Obtenir mon access_token Supabase</title>
<script src="/js/config.js"></script>
<script src="/js/utils.js"></script>
<body style="font-family: system-ui; padding: 20px">
  <h1>Get Token (Supabase)</h1>
  <p>Entre l'email et le mot de passe de ton agent, puis clique “Se connecter”.</p>

  <div style="margin:12px 0;">
    <label>Email <input id="email" value="agent@test.fr" style="width:320px" /></label>
  </div>
  <div style="margin:12px 0;">
    <label>Mot de passe <input id="pass" type="password" placeholder="••••••" style="width:320px" /></label>
  </div>
  <button id="go">Se connecter et afficher le token</button>

  <h3>Résultat</h3>
  <pre id="out" style="background:#f6f6f6; padding:12px; border:1px solid #ccc; white-space:pre-wrap;"></pre>

  <!-- SDK Supabase via CDN (aucune installation) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.47.6/dist/umd/supabase.js"></script>
  <script>
    const out = document.getElementById('out');
    const config = window.SUPABASE_CONFIG || {};

    if (!config.url || !config.anonKey) {
      out.textContent = 'Configuration Supabase invalide.';
      throw new Error('SUPABASE_CONFIG manquante');
    }

    const client = supabase.createClient(config.url, config.anonKey);

    document.getElementById('go').onclick = async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('pass').value.trim();
      out.textContent = 'Connexion en cours...';

      if (!email || !password) {
        out.textContent = 'Merci de renseigner email et mot de passe.';
        return;
      }

      try {
        const { data, error } = await client.auth.signInWithPassword({ email, password });
        if (error) {
          out.textContent = 'Erreur: ' + error.message;
          return;
        }

        const token = data.session?.access_token;
        if (!token) {
          out.textContent = 'Pas de token retourné.';
          return;
        }

        SAV.setToken(token);
        out.textContent = `ACCESS TOKEN:
${token}

Astuce: copie-colle ce token dans le champ "Token" de ta page chat, ou dans les tests d’API.`;
      } catch (e) {
        out.textContent = 'Exception: ' + (e?.message || e);
      }
    };
  </script>
</body>
</html>
