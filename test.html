<!doctype html>
<html lang="fr">
<meta charset="utf-8" />
<title>Test simulateur SAV</title>
<script src="/js/config.js"></script>
<script src="/js/utils.js"></script>
<body style="font-family: system-ui; padding: 20px">
  <h1>Test simulateur SAV</h1>

  <div style="margin-bottom:12px;">
    <label>Session ID:
      <input id="sid" value="demo" style="width:280px" />
    </label>
  </div>

  <div style="margin-bottom:12px;">
    <label>Message agent:
      <input id="msg" value="Bonjour, mon colis est indiqué livré mais je n'ai rien reçu."
             style="width:640px" />
    </label>
  </div>

  <details style="margin-bottom:12px;">
    <summary>Options avancées (facultatif)</summary>
    <div style="margin-top:8px">
      <label>Token (Authorization: Bearer …)
        <input id="tok" placeholder="colle ici ton access_token Supabase si tu es connecté"
               style="width:640px" />
      </label>
    </div>
  </details>

  <div style="display:flex; gap:8px; flex-wrap:wrap">
    <button id="ping">PING /api/simulator-chat (GET)</button>
    <button id="ask">Demander au client (POST)</button>
    <button id="rma">Créer RMA (POST)</button>
    <button id="discount">Essayer -20% (POST)</button>
    <button id="score">Clôturer & scorer (POST)</button>
  </div>

  <pre id="out" style="margin-top:16px; background:#f6f6f6; padding:12px; border:1px solid #ddd; white-space:pre-wrap;"></pre>

  <script>
    const out = document.getElementById('out');
    const sid = () => document.getElementById('sid').value || 'demo';
    const tok = () => document.getElementById('tok').value.trim();
    const msg = () => document.getElementById('msg').value || 'Bonjour';

    function display(data) {
      if (typeof data === 'string') {
        out.textContent = data;
      } else {
        out.textContent = JSON.stringify(data, null, 2);
      }
    }

    function displayError(error) {
      const payload = error?.data ?? error;
      const text = typeof payload === 'string' ? payload : JSON.stringify(payload, null, 2);
      out.textContent = 'Erreur: ' + text;
    }

    async function fetchJSON(url, init = {}) {
      const token = tok() || SAV.getToken();
      const result = await SAV.fetchJSON(url, {
        ...init,
        token: token || undefined,
        throwOnError: false
      });
      if (!result.ok) {
        throw result;
      }
      return result.data;
    }

    function bindAction(id, action) {
      document.getElementById(id).onclick = async () => {
        out.textContent = 'Chargement...';
        try {
          const data = await action();
          display(data ?? '(réponse vide)');
        } catch (e) {
          if (e.status === 401 || e.status === 403) {
            SAV.clearToken();
          }
          displayError(e);
        }
      };
    }

    bindAction('ping', () => fetchJSON('/api/simulator-chat'));
    bindAction('ask', () => fetchJSON('/api/simulator-chat', {
      method: 'POST',
      body: { session_id: sid(), agent_message: msg() }
    }));
    bindAction('rma', () => fetchJSON('/api/sav-action', {
      method: 'POST',
      body: { session_id: sid(), action_type: 'rma', justification: 'colis manquant' }
    }));
    bindAction('discount', () => fetchJSON('/api/sav-action', {
      method: 'POST',
      body: { session_id: sid(), action_type: 'discount', amount_cents: 1200, justification: 'défaut mineur' }
    }));
    bindAction('score', () => fetchJSON('/api/score-session', {
      method: 'POST',
      body: { session_id: sid() }
    }));
  </script>
</body>
</html>
