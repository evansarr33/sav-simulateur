<!doctype html>
<html lang="fr">
<meta charset="utf-8" />
<title>Test simulateur SAV</title>
<body style="font-family: system-ui; padding: 20px">
  <h1>Test simulateur SAV</h1>

  <div style="margin-bottom:12px;">
    <label>Session ID:
      <input id="sid" value="demo" style="width:280px" />
    </label>
  </div>

  <div style="margin-bottom:12px;">
    <label>Message agent:
      <input id="msg" value="Bonjour, mon colis est indiqué livré mais je n'ai rien reçu."
             style="width:640px" />
    </label>
  </div>

  <details style="margin-bottom:12px;">
    <summary>Options avancées (facultatif)</summary>
    <div style="margin-top:8px">
      <label>Token (Authorization: Bearer …)
        <input id="tok" placeholder="colle ici ton access_token Supabase si tu es connecté"
               style="width:640px" />
      </label>
    </div>
  </details>

  <div style="display:flex; gap:8px; flex-wrap:wrap">
    <button id="ping">PING /api/simulator-chat (GET)</button>
    <button id="ask">Demander au client (POST)</button>
    <button id="rma">Créer RMA (POST)</button>
    <button id="discount">Essayer -20% (POST)</button>
    <button id="score">Clôturer & scorer (POST)</button>
  </div>

  <pre id="out" style="margin-top:16px; background:#f6f6f6; padding:12px; border:1px solid #ddd; white-space:pre-wrap;"></pre>

  <script>
    const out = document.getElementById('out');
    const sid = () => document.getElementById('sid').value || 'demo';
    const tok = () => document.getElementById('tok').value.trim();
    const msg = () => document.getElementById('msg').value || 'Bonjour';

    const fetchJSON = (url, init={}) => {
      const headers = init.headers || {};
      const T = tok();
      if (T) headers['Authorization'] = 'Bearer ' + T;
      return fetch(url, { ...init, headers }).then(r=>r.text()).then(t=>{ try { return JSON.parse(t) } catch { return t }});
    };

    document.getElementById('ping').onclick = async () => {
      const r = await fetchJSON('/api/simulator-chat');
      out.textContent = JSON.stringify(r, null, 2);
    };

    document.getElementById('ask').onclick = async () => {
      const r = await fetchJSON('/api/simulator-chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ session_id: sid(), agent_message: msg() })
      });
      out.textContent = JSON.stringify(r, null, 2);
    };

    document.getElementById('rma').onclick = async () => {
      const r = await fetchJSON('/api/sav-action', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ session_id: sid(), action_type: 'rma', justification:'colis manquant' })
      });
      out.textContent = JSON.stringify(r, null, 2);
    };

    document.getElementById('discount').onclick = async () => {
      const r = await fetchJSON('/api/sav-action', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ session_id: sid(), action_type: 'discount', amount_cents: 1200, justification:'défaut mineur' })
      });
      out.textContent = JSON.stringify(r, null, 2);
    };

    document.getElementById('score').onclick = async () => {
      const r = await fetchJSON('/api/score-session', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ session_id: sid() })
      });
      out.textContent = JSON.stringify(r, null, 2);
    };
  </script>
</body>
</html>
