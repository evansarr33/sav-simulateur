<!doctype html>
<html lang="fr">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Espace agent — Conversation client</title>
<link rel="stylesheet" href="/style.css" />
<body>
<header class="bar">
  <h1>Conversation client</h1>
  <div class="small"><a href="/scenarios.html" style="color:#1d4ed8;text-decoration:none">← Dossiers clients</a></div>
</header>

<main class="layout">
  <section id="thread" class="thread"></section>
  <aside class="actions">
    <h3>Actions de suivi</h3>
    <button class="btn" data-act="rma">Créer RMA</button>
    <button class="btn" data-act="discount">Appliquer un geste commercial</button>
    <button class="btn" data-act="score" style="background:#16a34a">Clôturer & scorer</button>
    <div class="alert small">Identifiant dossier: <span id="sid"></span></div>
    <div class="alert small" style="margin-top:8px">Rappel: le correspondant reste un client réel pour vous. Ne mentionnez jamais d'outils internes ni d'IA.</div>
  </aside>
</main>

<footer class="composer">
  <input id="msg" placeholder="Rédigez votre réponse client..." />
  <button class="btn" id="send">Envoyer</button>
</footer>

<script>
const token = localStorage.getItem("sav_token") || "";
const q = new URLSearchParams(location.search);
const sessionId = q.get("session_id") || "";
document.getElementById('sid').textContent = sessionId || "(vide)";
const thread = document.getElementById('thread');
function formatText(text = "") {
  const cleaned = (text ?? "").toString().replace(/\u0000/g, "").trim();
  const safe = cleaned
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/\n/g, "<br>");
  return safe || "<span class=\"muted\">(message indisponible)</span>";
}
function addMsg(who, text) {
  const div = document.createElement("div");
  div.className = `msg ${who}`;
  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.innerHTML = formatText(text);
  div.appendChild(bubble);
  thread.appendChild(div);
  thread.scrollTop = thread.scrollHeight;
}

async function loadHistory() {
  if (!sessionId || !token) return;
  try {
    const r = await fetch(`/api/simulator-chat?session_id=${encodeURIComponent(sessionId)}`, {
      headers: { Authorization: "Bearer " + token }
    });
    if (!r.ok) return;
    const data = await r.json();
    (data.messages || []).forEach(m => {
      addMsg(m.author === "agent" ? "agent" : "bot", m.content);
    });
  } catch (e) {
    console.error("history load failed", e);
  }
}
async function postJSON(url, payload) {
  const r = await fetch(url, {
    method:"POST",
    headers: { "Content-Type":"application/json", "Authorization":"Bearer " + token },
    body: JSON.stringify(payload)
  });
  const t = await r.text();
  try { return JSON.parse(t) } catch { return { raw:t } }
}
document.getElementById('send').onclick = async () => {
  const input = document.getElementById('msg');
  const text = input.value.trim();
  if (!text || !sessionId) return;
  addMsg("agent", text);
  input.value = "";
  const resp = await postJSON("/api/simulator-chat", { session_id: sessionId, agent_message: text });
  const botText = resp.bot_message ?? resp.notice ?? JSON.stringify(resp);
  addMsg("bot", botText);
};
document.getElementById('msg').addEventListener('keydown', e => {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); document.getElementById('send').click(); }
});
document.querySelectorAll(".actions button").forEach(btn => {
  btn.onclick = async () => {
    const act = btn.dataset.act;
    if (act === "rma") {
      const r = await postJSON("/api/sav-action", { session_id: sessionId, action_type: "rma", justification:"colis manquant" });
      addMsg("bot", r.notice || JSON.stringify(r));
    } else if (act === "discount") {
      const r = await postJSON("/api/sav-action", { session_id: sessionId, action_type: "discount", amount_cents: 1200, justification:"défaut mineur" });
      addMsg("bot", r.notice || JSON.stringify(r));
    } else if (act === "score") {
      const r = await postJSON("/api/score-session", { session_id: sessionId });
      addMsg("bot", `Score total: ${r.total}/100\n${JSON.stringify(r.breakdown)}`);
    }
  };
});
loadHistory();
</script>
</body>
</html>
