<!doctype html>
<html lang="fr">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulateur SAV — Chat</title>
<link rel="stylesheet" href="/style.css" />
<script src="/js/config.js"></script>
<script src="/js/utils.js"></script>
<body>
<header class="bar">
  <h1>Chat de simulation</h1>
  <div class="small"><a href="/scenarios.html" style="color:#60a5fa;text-decoration:none">← Scénarios</a></div>
</header>

<main class="layout">
  <section id="thread" class="thread"></section>
  <aside class="actions">
    <h3>Actions SAV</h3>
    <button class="btn" data-act="rma">Créer RMA</button>
    <button class="btn" data-act="discount">-20% (test)</button>
    <button class="btn" data-act="score" style="background:#22c55e;color:#05240e">Clôturer & scorer</button>
    <div class="alert small">Session: <span id="sid"></span></div>
  </aside>
</main>

<footer class="composer">
  <input id="msg" placeholder="Tape ton message..." />
  <button class="btn" id="send">Envoyer</button>
</footer>

<script>
const q = new URLSearchParams(location.search);
const sessionId = q.get('session_id') || '';
const thread = document.getElementById('thread');
const composerInput = document.getElementById('msg');
const sendBtn = document.getElementById('send');

document.getElementById('sid').textContent = sessionId || '(vide)';

function addMsg(who, text) {
  const div = document.createElement('div');
  div.className = `msg ${who}`;
  div.innerHTML = `<div class="bubble">${(text || '').replace(/</g, '&lt;')}</div>`;
  thread.appendChild(div);
  thread.scrollTop = thread.scrollHeight;
}

function cleanText(t = '') {
  try {
    return String(t)
      .replace(/<\/?s>/gi, '')
      .replace(/\[(?:\/)?(?:OUT|INST|SYS|SYSTEM|USER|ASSISTANT)\]/gi, '')
      .replace(/<[^>]+>/g, '')
      .replace(/```[\s\S]*?```/g, '')
      .replace(/\n{3,}/g, '\n\n')
      .trim();
  } catch {
    return t || '';
  }
}

function handleUnauthorized() {
  addMsg('bot', 'Session expirée, retour à la connexion.');
  SAV.clearToken();
  setTimeout(() => {
    location.href = '/';
  }, 800);
}

async function postJSON(url, payload) {
  const result = await SAV.fetchJSON(url, {
    method: 'POST',
    body: payload,
    throwOnError: false
  });
  if (!result.ok) {
    if (result.status === 401 || result.status === 403) {
      handleUnauthorized();
    }
    throw result;
  }
  return result.data || {};
}

function ensureReady() {
  const token = SAV.getToken();
  if (!token) {
    addMsg('bot', '⚠️ Token manquant. Merci de vous reconnecter.');
    setTimeout(() => {
      location.href = '/';
    }, 1200);
    return false;
  }
  if (!sessionId) {
    addMsg('bot', '⚠️ Session introuvable. Reprenez depuis la liste des scénarios.');
    sendBtn.disabled = true;
    composerInput.disabled = true;
    return false;
  }
  return true;
}

sendBtn.addEventListener('click', async () => {
  if (!ensureReady()) {
    return;
  }
  const text = composerInput.value.trim();
  if (!text) {
    return;
  }
  addMsg('agent', text);
  composerInput.value = '';
  try {
    const resp = await postJSON('/api/simulator-chat', { session_id: sessionId, agent_message: text });
    addMsg('bot', cleanText(resp.bot_message || JSON.stringify(resp)));
  } catch (e) {
    const message = typeof e?.data === 'string' ? e.data : (e?.message || 'Erreur inconnue');
    addMsg('bot', 'Erreur: ' + message);
  }
});

composerInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendBtn.click();
  }
});

document.querySelectorAll('.actions button').forEach(btn => {
  btn.addEventListener('click', async () => {
    if (!ensureReady()) {
      return;
    }
    const act = btn.dataset.act;
    try {
      if (act === 'rma') {
        const r = await postJSON('/api/sav-action', { session_id: sessionId, action_type: 'rma', justification: 'colis manquant' });
        addMsg('bot', r.notice || JSON.stringify(r));
      } else if (act === 'discount') {
        const r = await postJSON('/api/sav-action', { session_id: sessionId, action_type: 'discount', amount_cents: 1200, justification: 'défaut mineur' });
        addMsg('bot', r.notice || JSON.stringify(r));
      } else if (act === 'score') {
        const r = await postJSON('/api/score-session', { session_id: sessionId });
        addMsg('bot', `Score total: ${r.total}/100\n${JSON.stringify(r.breakdown)}`);
      }
    } catch (e) {
      const message = typeof e?.data === 'string' ? e.data : (e?.message || 'Erreur inconnue');
      addMsg('bot', 'Erreur: ' + message);
    }
  });
});

ensureReady();
</script>
</body>
</html>
